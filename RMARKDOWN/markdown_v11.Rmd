---
title: "Mineração de texto em pedidos de Lei de Acesso ä informação - LAI"
output: 
  pdf_document: 
    keep_tex: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

 <!-- REFERÊNCIAS
 https://www.tidytextmining.com/tidytext.html#contrasting-tidy-text-with-other-data-structures
 
 -->

## Packages for this routine
```{r, include=FALSE, message=FALSE}
# install.packages("readODS")
library(readODS)        # read .ods file
library(tidyverse)      # data manipulation tidyverse_packages()
library(tidytext)       # Text Mining using 'dplyr', 'ggplot2', and other Tidy Tools
library(tidyr)          # Easily Tidy Data with 'spread()' and 'gather()' Functions
library(stringr)
library(knitr)
library(kableExtra)
```


## Importação e preparação dos dados

### Pedidos e-SIC
```{r}
PATH = "C:/proj_eSIC_v10/textmining_pt/DATA/"
#PATH = "/Users/ewersonpimenta/Desktop/ESIC_TCC/Pedidos_LAI_EPE/BASE_DADOS/"
FILE = "relatorio_pedidos.ods"
db_raw = readODS::read.ods(file = paste0(PATH,FILE), sheet = 1); # dim(db_raw)
dbnames = db_raw[1,]; db_raw = db_raw[-1,]; 
colnames(db_raw) = c("ID", "DATA_PEDIDO", "DATA_PRAZOATEND", "DESCRI_PEDIDO",
                     "RESUMO_PEDIDO", "DATA_RESPOSTA")
#View(head(db_raw))
LAI = db_raw
```

### Respostas e-SIC
```{r}
FILE1 = "relatorio_respostas.xlsx"
db1_raw = readxl::read_excel(paste0(PATH,FILE1), sheet = "DADOS", col_names = TRUE); 
# dim(db1_raw); names(db1_raw)
colnames(db1_raw) = c("ID", "DATA", "SOLICITACAO", "DIRETORIA", "DATA_RESPOSTA")
#View(head(db1_raw))
LAI1 = db1_raw
```

#### Freq. de solicitações no e-SIC por Diretoria da EPE
```{r}
LAI1 %>%
 count(DIRETORIA, sort = TRUE) %>%
  kable("latex", caption = "Frequência de solicitações e-SIC por Diretoria/EPE",
        booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```



#### Respostas e-SIC - Reclassificação Diretorias
```{r}
diretorias = levels(as.factor(LAI1$DIRETORIA))
LAI1 = LAI1 %>% 
  mutate(DIRETORIA = ifelse(DIRETORIA == diretorias[6],diretorias[5],DIRETORIA))
diretorias = levels(as.factor(LAI1$DIRETORIA))
LAI1 = LAI1 %>% 
  mutate(DIR_NEW = ifelse(DIRETORIA == diretorias[1],diretorias[1],
                          ifelse(DIRETORIA == diretorias[2],diretorias[2], "OUTRAS")))
#dim(LAI1)
#View(head(LAI1))
```

```{r}
LAI1 %>%
 count(DIRETORIA, sort = TRUE) %>%
  kable("latex", caption = "Frequência de solicitações e-SIC por Diretoria/EPE - sem SIC", 
        booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```yaml
LAI1 %>%
 count(DIRETORIA, sort = TRUE) %>%
  kable("html", caption = "Frequência de solicitações e-SIC por Diretoria/EPE - sem SIC", 
        booktabs = T) %>%
  kable_styling(bootstrap_options = c("striped", "hold_position"))
```


```{r}
LAI1 %>%
 count(DIR_NEW, sort = TRUE) %>%
  kable("latex", caption = "Frequência de solicitações e-SIC por Diretoria/EPE (TOP2)",
        booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


```yaml
LAI1 %>%
 count(DIR_NEW, sort = TRUE) %>%
  kable("html", caption = "Frequência de solicitações e-SIC por Diretoria/EPE (TOP2)",
        booktabs = T) %>%
  kable_styling(bootstrap_options = c("striped", "hold_position"))
```



### Unificando as duas bases
```{r}
LAI = LAI %>% select(-DATA_RESPOSTA); #dim(LAI)
LAI1 = LAI1 %>% select(-DATA); #dim(LAI1)
DB = left_join(x = LAI, y = LAI1, by = "ID")
#View(head(DB))
DB[c(32,50,66),c(-1,-3,-5,-6,-9)] %>%
  select(DATA_PEDIDO, DATA_RESPOSTA, DIRETORIA, DESCRI_PEDIDO) %>%
kable("latex", caption = "Amostra dos dados a serem pré-processados", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"), full_width = F) %>%
  column_spec(4:4, width = "2cm") %>%
  column_spec(5:5, width = "10cm") %>%
landscape()
```

### Análise de texto 

#### Frequência de palavras por diretoria
```{r 02_freq_palavras_dir, fig.width=9, fig.height=7}
diretoria_palavras <- DB %>%
  unnest_tokens(palavra, DESCRI_PEDIDO) %>%
  count(DIRETORIA, palavra, sort = TRUE) %>%
  ungroup()
#diretoria_palavras

plot_diretoria_palavras <- diretoria_palavras %>%
  bind_tf_idf(palavra, DIRETORIA, n) %>%
  arrange(desc(tf_idf)) %>%
  mutate(palavra = factor(palavra, levels = rev(unique(palavra)))) %>%
  mutate(DIRETORIA = factor(DIRETORIA, levels = c("DEA",
                                                  "DEE",
                                                  "DGC",
                                                  "DPG",
                                                  "OUTROS")))
#View(head(plot_diretoria_palavras))
#jpeg("02_freq_palavras_dir.jpeg")
plot_diretoria_palavras %>%
group_by(DIRETORIA) %>%
top_n(10, tf_idf) %>%
ungroup() %>%
mutate(palavra = reorder(palavra, tf_idf)) %>%
ggplot(aes(palavra, tf_idf, fill = DIRETORIA)) +
geom_col(show.legend = FALSE) +
labs(x = NULL, y = "tf-idf") +
facet_wrap(~DIRETORIA, ncol = 2, scales = "free") +
coord_flip()
#dev.off()
```

#### Filtrando um pedaço de texto
```{r}
DB %>%
filter(str_detect(DESCRI_PEDIDO, "r0")) %>%
select(DESCRI_PEDIDO) %>%
  head()
```

Uma limpeza removendo palavras sem significado semântico (**stopwords**) pode auxiliar o algoritmo a retornar palavras ainda mais acertivas


### Radicais
Podemos diminuir redundâncias por parte do algoritmo ensinando-o a compreender palavras que podem estar escritas de forma diferente mas que em significado semântico são semelhantes. Para isso, analisamos o radical de palavras com um mesmo prefixo mas com sufixos diferentes seja por quisistos como gênero ou plural.

Exemplos:

leilão $\propto$ leilões
estado $\propto$ estados
região $\propto$ regiões

`Falta implementar`


### Stopwords
```{r cars}
FILE2 = "stopwords_PT_FINAL.csv"
stopwords_pt = read.csv(paste0(PATH,FILE2), sep = ';', header = F, encoding = "UTF-8")
stopwords_pt = stopwords_pt[,-2]; 
cat(paste0("O nosso vetor de stopwords contém ",length(stopwords_pt), " palavras únicas"))
## dim(stopwords_pt); class(stopwords_pt)
stopwords_pt = as.character(stopwords_pt)
stopwords_pt[1:14]
```

#### Freq. de palavras sem **stopwords** por diretoria
```{r}
mystopwords <- data_frame(palavra = stopwords_pt)
diretoria_palavras_noSTOP <- anti_join(diretoria_palavras, mystopwords, by = "palavra")
#View(head(diretoria_palavras_noSTOP))
```

```{r 03_freq_palavras_dir_nostop, fig.width=9, fig.height=7}
#diretoria_palavras_noSTOP_noSTOP
plot_diretoria_palavras_noSTOP <- diretoria_palavras_noSTOP %>%
  bind_tf_idf(palavra, DIRETORIA, n) %>%
  arrange(desc(tf_idf)) %>%
  mutate(word = factor(palavra, levels = rev(unique(palavra)))) %>%
  mutate(DIRETORIA = factor(DIRETORIA, levels = c("DEA",
                                                  "DEE",
                                                  "DGC",
                                                  "DPG",
                                                  "OUTROS")))
#plot_diretoria_palavras_noSTOP
#windows.options(width=10, height=10)
#jpeg("03_freq_palavras_dir_nostop.jpeg")
plot_diretoria_palavras_noSTOP %>%
group_by(DIRETORIA) %>%
top_n(10, tf_idf) %>%
ungroup() %>%
mutate(palavra = reorder(palavra, tf_idf)) %>%
ggplot(aes(palavra, tf_idf, fill = DIRETORIA)) +
geom_col(show.legend = FALSE) +
labs(x = NULL, y = "tf-idf") +
facet_wrap(~DIRETORIA, ncol = 2, scales = "free") +
coord_flip()
#dev.off()
```


### Usando bigram para n=2 palavras por token
#### Frequência de palavras por diretoria
```{r 03_freq_palavras_dir, fig.width=9, fig.height=7}
diretoria_palavras_bigram <- DB %>%
  select(DESCRI_PEDIDO,DIRETORIA) %>%
  unnest_tokens(BIGRAM, DESCRI_PEDIDO, token = "ngrams", n = 2) %>%
  count(DIRETORIA, BIGRAM, sort = TRUE) %>%
  ungroup()
#diretoria_palavras_bigram

plot_diretoria_palavras_bigram <- diretoria_palavras_bigram %>%
  bind_tf_idf(BIGRAM, DIRETORIA, n) %>%
  arrange(desc(tf_idf)) %>%
  mutate(BIGRAM = factor(BIGRAM, levels = rev(unique(BIGRAM)))) %>%
  mutate(DIRETORIA = factor(DIRETORIA, levels = c("DEA",
                                                  "DEE",
                                                  "DGC",
                                                  "DPG",
                                                  "OUTROS")))
#View(head(plot_diretoria_palavras_bigram))
#jpeg("02_freq_palavras_dir.jpeg")
plot_diretoria_palavras_bigram %>%
group_by(DIRETORIA) %>%
top_n(10, tf_idf) %>%
ungroup() %>%
mutate(BIGRAM = reorder(BIGRAM, tf_idf)) %>%
ggplot(aes(BIGRAM, tf_idf, fill = DIRETORIA)) +
geom_col(show.legend = FALSE) +
labs(x = NULL, y = "tf-idf") +
facet_wrap(~DIRETORIA, ncol = 2, scales = "free") +
coord_flip()
#dev.off()
```

### Usando bigram para n=3 palavras por token
#### Frequência de palavras por diretoria
```{r 04_freq_palavras_dir, fig.width=9, fig.height=7}
diretoria_palavras_trigram <- DB %>%
  select(DESCRI_PEDIDO,DIRETORIA) %>%
  unnest_tokens(TRIGRAM, DESCRI_PEDIDO, token = "ngrams", n = 3) %>%
  count(DIRETORIA, TRIGRAM, sort = TRUE) %>%
  ungroup()
#diretoria_palavras_trigram

plot_diretoria_palavras_trigram <- diretoria_palavras_trigram %>%
  bind_tf_idf(TRIGRAM, DIRETORIA, n) %>%
  arrange(desc(tf_idf)) %>%
  mutate(TRIGRAM = factor(TRIGRAM, levels = rev(unique(TRIGRAM)))) %>%
  mutate(DIRETORIA = factor(DIRETORIA, levels = c("DEA",
                                                  "DEE",
                                                  "DGC",
                                                  "DPG",
                                                  "OUTROS")))
#View(head(plot_diretoria_palavras_trigram))
#jpeg("02_freq_palavras_dir.jpeg")
plot_diretoria_palavras_trigram %>%
group_by(DIRETORIA) %>%
top_n(10, tf_idf) %>%
ungroup() %>%
mutate(TRIGRAM = reorder(TRIGRAM, tf_idf)) %>%
ggplot(aes(TRIGRAM, tf_idf, fill = DIRETORIA)) +
geom_col(show.legend = FALSE) +
labs(x = NULL, y = "tf-idf") +
facet_wrap(~DIRETORIA, ncol = 2, scales = "free") +
coord_flip()
#dev.off()
```

